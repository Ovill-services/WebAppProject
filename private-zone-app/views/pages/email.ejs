<div class="main-content">
        <div class="container mt-5">

            <!-- Enhanced header with better styling -->
            <div class="enhanced-page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                                <div class="card-body p-0">
                                <i class="bi bi-calendar-event"></i>
                            </div>
                        </div>
                        <div>
                            <h1 class="mb-1" data-translate="email.title">Emails</h1>
                            <p class="text-muted mb-0">Manage your emails efficiently</p>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="enhanced-time-card card border-0">
                            <div class="card-body py-2 px-3">
                                <small class="text-muted d-block">Current Time</small>
                                <strong class="text-body">
                                    <i class="bi bi-clock me-1"></i>
                                    <span id="currentTime"></span>
                                </strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Actions Bar -->
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-primary text-white py-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0 d-flex align-items-center fw-bold">
                                <i class="bi bi-inbox me-2"></i><span data-translate="email.inbox">Inbox</span>
                            </h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-flex align-items-center justify-content-end gap-2">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="emailActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-clock me-1"></i>Auto Sync (5 min)
                                    </button>
                                    <ul class="dropdown-menu shadow-lg" aria-labelledby="emailActionsDropdown">
                                        <li><h6 class="dropdown-header">Sync Interval</h6></li>
                                        <li><a href="#" class="dropdown-item" data-interval="5 min">
                                            <i class="bi bi-clock me-2"></i>5 minutes
                                        </a></li>
                                        <li><a href="#" class="dropdown-item" data-interval="10 min">
                                            <i class="bi bi-clock me-2"></i>10 minutes
                                        </a></li>
                                        <li><a href="#" class="dropdown-item" data-interval="30 min">
                                            <i class="bi bi-clock me-2"></i>30 minutes
                                        </a></li>
                                        <li><a href="#" class="dropdown-item" data-interval="1 hr">
                                            <i class="bi bi-clock me-2"></i>1 hour
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a href="#" class="dropdown-item text-danger" onclick="pauseAutoSync()">
                                            <i class="bi bi-pause-circle me-2"></i>Pause Auto Sync
                                        </a></li>
                                    </ul>
                                </div>
                                <button class="btn btn-info btn-sm page-action-btn"
                                    onclick="syncGmailEmails(), setTimeout(refreshEmails, 2000)" id="gmailSyncBtn">
                                    <i class="bi bi-cloud-download me-1"></i><span data-translate="email.syncGmail">Sync
                                        Gmail</span>
                                </button>
                                <!-- Render toggle button (original / theme view) -->
                                <button id="emailViewToggleRenderBtn" class="btn btn-outline-secondary btn-sm page-action-btn" title="Toggle original / theme view">Theme view</button>
                                <button class="btn btn-outline-primary btn-sm page-action-btn" onclick="refreshEmails()">
                                    <i class="bi bi-arrow-clockwise me-1"></i><span
                                        data-translate="email.refresh">Refresh</span>
                                </button>
                                <button class="btn btn-warning btn-sm page-action-btn" onclick="composeEmail()" data-bs-toggle="modal"
                                    data-bs-target="#composeModal">
                                    <i class="bi bi-pencil-square me-1"></i><span
                                        data-translate="email.compose">Compose</span>
                                </button>
                            </div>
                        
                        </div>
                    </div>
                </div>

                <!-- Email Filters -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <select class="form-select" id="emailFilter" onchange="filterEmails()">
                                    <option value="all" data-translate="email.allEmails">All Emails</option>
                                    <option value="unread" data-translate="email.unread">Unread</option>
                                    <option value="read" data-translate="email.read">Read</option>
                                    <option value="important" data-translate="email.important">Important</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="emailSearch"
                                        placeholder="Search emails..."
                                        data-translate-placeholder="email.searchPlaceholder" onkeyup="searchEmails()">
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <small class="text-muted">
                                    <span id="emailCount">0</span> <span data-translate="email.emailsTotal">emails
                                        total</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email List -->
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div id="emailList">
                            <!-- Loading state -->
                            <div id="emailLoading" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted" data-translate="email.loading">Loading emails...</p>
                            </div>

                            <!-- Empty state -->
                            <div id="emailEmpty" class="text-center py-5" style="display: none;">
                                <i class="bi bi-inbox display-1 text-muted"></i>
                                <h5 class="mt-3 text-muted" data-translate="email.noEmails">No emails found</h5>
                                <p class="text-muted" data-translate="email.noEmailsDescription">Your inbox is empty or no emails match your search criteria.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gmail Integration -->
            <div class="container mt-5">
                <div class="row">
                    <div class="col-2">
                    </div>
                    <div class="col-12">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-info text-white py-3">
                                <h6 class="mb-0 d-flex align-items-center">
                                    <i class="bi bi-envelope-at me-2"></i>Gmail Integration
                                </h6>
                            </div>
                            <div class="card-body text-center py-5">
                                <div class="mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100"
                                        viewBox="0 0 48 48">
                                        <path fill="#4caf50"
                                            d="M45,16.2l-5,2.75l-5,4.75L35,40h7c1.657,0,3-1.343,3-3V16.2z">
                                        </path>
                                        <path fill="#1e88e5"
                                            d="M3,16.2l3.614,1.71L13,23.7V40H6c-1.657,0-3-1.343-3-3V16.2z">
                                        </path>
                                        <polygon fill="#e53935"
                                            points="35,11.2 24,19.45 13,11.2 12,17 13,23.7 24,31.95 35,23.7 36,17">
                                        </polygon>
                                        <path fill="#c62828"
                                            d="M3,12.298V16.2l10,7.5V11.2L9.876,8.859C9.132,8.301,8.228,8,7.298,8h0C4.924,8,3,9.924,3,12.298z">
                                        </path>
                                        <path fill="#fbc02d"
                                            d="M45,12.298V16.2l-10,7.5V11.2l3.124-2.341C38.868,8.301,39.772,8,40.702,8h0 C43.076,8,45,9.924,45,12.298z">
                                        </path>
                                    </svg>
                                </div>
                                <h5 class="mb-3">Gmail Integration</h5>
                                <p class="text-muted mb-4 col-md-8 mx-auto">
                                    Your Gmail emails can be automatically synced when you connect your Gmail account!
                                    All your
                                    emails are imported and managed in one place.
                                </p>

                                <div class="row justify-content-center">
                                    <div class="col-md-8">
                                        <div class="alert alert-info d-flex align-items-center" role="alert"
                                            id="gmailIntegrationAlert">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <div id="gmailStatusMessage">
                                                Checking Gmail connection...
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                            <button class="btn btn-primary" id="gmailConnectBtn"
                                                onclick="connectGmail()" style="display: none;">
                                                <i class="bi bi-google me-2"></i>Connect Gmail
                                            </button>
                                            <button class="btn btn-success" id="gmailConnectedBtn"
                                                style="display: none;" disabled>
                                                <i class="bi bi-check-circle me-2"></i>Connected
                                            </button>
                                            <button class="btn btn-outline-secondary" id="gmailDisconnectBtn"
                                                onclick="disconnectGmail()" style="display: none;">
                                                <i class="bi bi-x-circle me-2"></i>Disconnect
                                            </button>
                                            <button class="btn btn-info" onclick="syncGmailEmails()" id="gmailSyncBtn"
                                                style="display: none;">
                                                <i class="bi bi-cloud-download me-2"></i>Sync Gmail
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <small class="text-muted">
                                        <i class="bi bi-shield-check me-1"></i>All integrations are secure and encrypted
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compose Email Modal -->
        <div class="modal fade" id="composeModal" tabindex="-1" aria-labelledby="composeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="composeModalLabel">
                            <i class="bi bi-pencil-square me-2"></i><span data-translate="email.composeEmail">Compose
                                Email</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="composeForm">
                            <div class="mb-3">
                                <label for="emailTo" class="form-label" data-translate="email.to">To</label>
                                <input type="email" class="form-control" id="emailTo" required
                                    data-translate-placeholder="email.toPlaceholder"
                                    placeholder="recipient@example.com">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="emailCc" class="form-label" data-translate="email.cc">CC</label>
                                        <input type="email" class="form-control" id="emailCc"
                                            data-translate-placeholder="email.ccPlaceholder"
                                            placeholder="cc@example.com">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="emailBcc" class="form-label" data-translate="email.bcc">BCC</label>
                                        <input type="email" class="form-control" id="emailBcc"
                                            data-translate-placeholder="email.bccPlaceholder"
                                            placeholder="bcc@example.com">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="emailSubject" class="form-label"
                                    data-translate="email.subject">Subject</label>
                                <input type="text" class="form-control" id="emailSubject" required
                                    data-translate-placeholder="email.subjectPlaceholder" placeholder="Enter subject">
                            </div>
                            <div class="mb-3">
                                <label for="emailBody" class="form-label" data-translate="email.message">Message</label>
                                <textarea class="form-control" id="emailBody" rows="8" required
                                    data-translate-placeholder="email.messagePlaceholder"
                                    placeholder="Enter your message here..."></textarea>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="emailPriority">
                                    <label class="form-check-label" for="emailPriority"
                                        data-translate="email.highPriority">
                                        Mark as high priority
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                            data-translate="email.cancel">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="sendEmail()">
                            <i class="bi bi-send me-1"></i><span data-translate="email.send">Send Email</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Email View Modal -->
        <div class="modal fade" id="emailViewModal" tabindex="-1" aria-labelledby="emailViewModalLabel"
            aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content email-view-card border-0 shadow-lg bg-body text-body">
                    <!-- Enhanced Modern Header -->
                    <div class="modal-header border-0 py-4 email-view-header bg-body text-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="bg-primary bg-opacity-15 rounded-circle p-3">
                                    <i class="bi bi-envelope-open-fill text-white fs-4"></i>
                                </div>
                            </div>
                            <div>
                                <h4 class="modal-title mb-1 fw-bold" id="emailViewModalLabel">
                                    <span data-translate="email.viewEmail">Email Details</span>
                                </h4>
                                <small class="text-muted">Professional Email Viewer</small>
                            </div>
                        </div>
                        <div class="ms-3 d-flex align-items-center">
                            <!-- Render toggle: Theme-adapted (default) / Original HTML -->
                            <button id="emailViewToggleRenderBtn" class="btn btn-sm btn-outline-secondary me-2" title="Toggle original / theme view">Theme view</button>
                        </div>
                        <button type="button" class="btn-close btn-close-lg" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>

                    <!-- Enhanced Email Content -->
                    <div class="modal-body p-0">
                        <div id="emailViewContent" class="email-viewer bg-transparent">
                            <!-- Enhanced email content will be loaded here -->
                        </div>
                    </div>

                    <!-- Enhanced Professional Action Bar -->
                    <div class="modal-footer email-view-footer border-0 py-3 bg-body text-body">
                        <div class="d-flex flex-wrap gap-2 w-100 justify-content-between">
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="page-action-btn btn btn-primary d-flex align-items-center"
                                    onclick="replyToEmail()">
                                    <i class="bi bi-reply-fill me-2"></i>
                                    <span data-translate="email.reply">Reply</span>
                                </button>
                                <button type="button" class="btn btn-outline-primary d-flex align-items-center"
                                    onclick="forwardEmail()">
                                    <i class="bi bi-arrow-right-circle me-2"></i>
                                    <span data-translate="email.forward">Forward</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary d-flex align-items-center"
                                    onclick="toggleImportantFromModal()">
                                    <i class="bi bi-star me-2" id="modalImportantIcon"></i>
                                    <span id="modalImportantText">Mark Important</span>
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-danger d-flex align-items-center"
                                    onclick="deleteEmail()">
                                    <i class="bi bi-trash3 me-2"></i>
                                    <span data-translate="email.delete">Delete</span>
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-lg me-2"></i>Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Helper function to safely use Swal
            function safeSwal(config) {
                if (typeof Swal !== 'undefined') {
                    return Swal.fire(config);
                } else {
                    console.log('SweetAlert2 not available, using fallback');
                    // Fallback for basic operations
                    if (config.text) {
                        if (config.icon === 'error') {
                            alert('Error: ' + config.text);
                        } else if (config.showCancelButton) {
                            return Promise.resolve({ isConfirmed: confirm(config.text) });
                        } else {
                            alert(config.text);
                        }
                    }
                    return Promise.resolve({ isConfirmed: true });
                }
            }

            // Theme-aware SweetAlert2 configuration
            function getSweetAlertTheme() {
                const htmlElement = document.documentElement;
                const currentTheme = htmlElement.getAttribute('data-bs-theme');

                if (currentTheme === 'dark') {
                    return {
                        background: '#2d3748',
                        color: '#e2e8f0',
                        confirmButtonColor: '#4299e1',
                        cancelButtonColor: '#a0aec0'
                    };
                } else {
                    return {
                        background: '#ffffff',
                        color: '#2d3748',
                        confirmButtonColor: '#3182ce',
                        cancelButtonColor: '#718096'
                    };
                }
            }

            function getThemeColor(colorType) {
                const theme = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'light';

                const colors = {
                    dark: {
                        primary: '#4299e1',
                        secondary: '#a0aec0',
                        success: '#48bb78',
                        danger: '#f56565',
                        warning: '#ed8936',
                        info: '#4299e1',
                        bg: '#2d3748',
                        text: '#e2e8f0'
                    },
                    light: {
                        primary: '#3182ce',
                        secondary: '#718096',
                        success: '#38a169',
                        danger: '#e53e3e',
                        warning: '#dd6b20',
                        info: '#3182ce',
                        bg: '#ffffff',
                        text: '#2d3748'
                    }
                };

                return colors[theme][colorType] || colors.light[colorType];
            }

            // Email functionality
            let emails = [];
            let currentEmail = null;
            let autoSyncInterval = null;
            let currentAutoSyncTime = 300000; // Default 5 minutes

            // Rendering toggle: allow user to switch between theme-adapted view and original view
            function setupEmailRenderToggle(bodyContainer, rawHtml) {
                try {
                    const toggleBtn = document.getElementById('emailViewToggleRenderBtn');
                    if (!toggleBtn) return;

                    // Keep state on the button dataset
                    toggleBtn.dataset.mode = 'theme'; // 'theme' or 'original'
                    toggleBtn.textContent = 'Theme view';

                    // Ensure click handler is idempotent
                    toggleBtn.onclick = function () {
                        const currentMode = toggleBtn.dataset.mode;
                        if (currentMode === 'theme') {
                            // switch to original HTML rendering (preserve original HTML, no injected theme overrides)
                            renderOriginalHtmlInIframe(bodyContainer, rawHtml);
                            toggleBtn.dataset.mode = 'original';
                            toggleBtn.textContent = 'Original view';
                        } else {
                            // switch back to theme-adapted rendering
                            renderEmailThemeInIframe(bodyContainer, rawHtml);
                            toggleBtn.dataset.mode = 'theme';
                            toggleBtn.textContent = 'Theme view';
                        }
                    };
                } catch (err) {
                    console.error('Failed to setup render toggle', err);
                }
            }

            // Render original HTML inside iframe without injecting theme overrides
            function renderOriginalHtmlInIframe(container, html) {
                try {
                    container.innerHTML = '';
                    const srcdoc = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>html,body{margin:0;padding:12px;background:transparent;color:inherit;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial} img{max-width:100% !important;height:auto !important;display:block;margin:0 auto} table{max-width:100% !important;width:100% !important;border-collapse:collapse} a{color:#1a73e8}</style></head><body><div>${html}</div></body></html>`;

                    const iframe = document.createElement('iframe');
                    iframe.className = 'email-iframe border-0 rounded-2';
                    iframe.setAttribute('sandbox', '');
                    iframe.setAttribute('scrolling', 'auto');
                    iframe.style.width = '100%';
                    iframe.style.minHeight = '60vh';
                    iframe.style.border = '0';
                    iframe.srcdoc = srcdoc;

                    container.appendChild(iframe);
                } catch (err) {
                    console.error('Failed to render original HTML in iframe', err);
                    container.innerText = html;
                }
            }

            // Initialize email page
            document.addEventListener('DOMContentLoaded', function () {
                console.log('Email page initializing...');
                updateCurrentTime();
                setInterval(updateCurrentTime, 60000);
                loadEmails(); // Load emails first
                checkGmailStatus();
                setupAutoSync(currentAutoSyncTime); // Setup auto sync with default interval
                setInterval(loadEmails, 300000); // Refresh emails every 5 minutes
                setupAutoSyncDropdown(); // Setup dropdown functionality
                loadAutoSyncPreference(); // Load saved auto sync preference
                console.log('Email page initialized successfully');
            });

            function updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = timeString;
                }
            }

            // Auto Sync Functionality
            function setupAutoSyncDropdown() {
                const dropdownItems = document.querySelectorAll('#emailActionsDropdown + .dropdown-menu .dropdown-item');
                const dropdownButton = document.getElementById('emailActionsDropdown');
                
                if (!dropdownButton) {
                    console.log('Auto sync dropdown not found, skipping setup');
                    return;
                }
                
                dropdownItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const selectedTime = this.textContent.trim();
                        setAutoSyncInterval(selectedTime);
                        
                        // Update button text to show selected interval
                        dropdownButton.innerHTML = `<i class="bi bi-clock me-1"></i>Auto Sync (${selectedTime})`;
                        
                        // Show success message
                        showSuccess(`Auto sync set to ${selectedTime}`);
                    });
                });
            }

            function setAutoSyncInterval(timeText) {
                // Clear existing interval
                if (autoSyncInterval) {
                    clearInterval(autoSyncInterval);
                }

                // Convert time text to milliseconds
                let intervalMs;
                switch (timeText) {
                    case '5 min':
                        intervalMs = 5 * 60 * 1000; // 5 minutes
                        break;
                    case '10 min':
                        intervalMs = 10 * 60 * 1000; // 10 minutes
                        break;
                    case '30 min':
                        intervalMs = 30 * 60 * 1000; // 30 minutes
                        break;
                    case '1 hr':
                        intervalMs = 60 * 60 * 1000; // 1 hour
                        break;
                    default:
                        intervalMs = 5 * 60 * 1000; // Default to 5 minutes
                }

                currentAutoSyncTime = intervalMs;
                setupAutoSync(intervalMs);
                
                // Store the preference in localStorage
                localStorage.setItem('autoSyncInterval', timeText);
                
                // Update next sync time display
                updateNextSyncTime(intervalMs);
            }

            function setupAutoSync(intervalMs) {
                // Clear existing interval
                if (autoSyncInterval) {
                    clearInterval(autoSyncInterval);
                }

                // Set up new interval for auto sync
                autoSyncInterval = setInterval(() => {
                    console.log('Auto sync triggered');
                    syncGmailEmailsQuietly(); // Use quiet version to avoid showing success messages every time
                    updateNextSyncTime(intervalMs); // Update next sync time after each sync
                }, intervalMs);

                console.log(`Auto sync setup with interval: ${intervalMs}ms`);
                
                // Update next sync time display
                updateNextSyncTime(intervalMs);
            }

            function updateNextSyncTime(intervalMs) {
                const nextSyncTime = new Date(Date.now() + intervalMs);
                const timeString = nextSyncTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Add a small indicator showing next sync time (you can customize this)
                const dropdownButton = document.getElementById('emailActionsDropdown');
                const currentText = dropdownButton.textContent.split('(')[0].trim();
                const intervalText = getIntervalText(intervalMs);
                dropdownButton.innerHTML = `<i class="bi bi-clock me-1"></i>${currentText} (${intervalText}) <small class="text-muted">Next: ${timeString}</small>`;
            }

            function getIntervalText(intervalMs) {
                switch (intervalMs) {
                    case 5 * 60 * 1000: return '5 min';
                    case 10 * 60 * 1000: return '10 min';
                    case 30 * 60 * 1000: return '30 min';
                    case 60 * 60 * 1000: return '1 hr';
                    default: return '5 min';
                }
            }

            // Load saved auto sync preference on page load
            function loadAutoSyncPreference() {
                const savedInterval = localStorage.getItem('autoSyncInterval');
                if (savedInterval) {
                    setAutoSyncInterval(savedInterval);
                    const dropdownButton = document.getElementById('emailActionsDropdown');
                    dropdownButton.innerHTML = `<i class="bi bi-clock me-1"></i>Auto Sync (${savedInterval})`;
                }
            }

            // Pause/Resume auto sync functionality
            function pauseAutoSync() {
                if (autoSyncInterval) {
                    clearInterval(autoSyncInterval);
                    autoSyncInterval = null;
                    
                    const dropdownButton = document.getElementById('emailActionsDropdown');
                    dropdownButton.innerHTML = `<i class="bi bi-pause-circle me-1"></i>Auto Sync (Paused)`;
                    dropdownButton.className = 'btn btn-warning btn-sm dropdown-toggle';
                    
                    showSuccess('Auto sync paused');
                    
                    // Update the dropdown to show resume option
                    updateDropdownForPausedState();
                } else {
                    resumeAutoSync();
                }
            }

            function resumeAutoSync() {
                const savedInterval = localStorage.getItem('autoSyncInterval') || '5 min';
                setAutoSyncInterval(savedInterval);
                
                const dropdownButton = document.getElementById('emailActionsDropdown');
                dropdownButton.className = 'btn btn-outline-secondary btn-sm dropdown-toggle';
                
                showSuccess('Auto sync resumed');
                
                // Update the dropdown back to normal state
                updateDropdownForActiveState();
            }

            function updateDropdownForPausedState() {
                const dropdown = document.querySelector('#emailActionsDropdown + .dropdown-menu');
                dropdown.innerHTML = `
                    <li><h6 class="dropdown-header">Auto Sync Paused</h6></li>
                    <li><a href="#" class="dropdown-item text-success" onclick="resumeAutoSync()">
                        <i class="bi bi-play-circle me-2"></i>Resume Auto Sync
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Change Interval</h6></li>
                    <li><a href="#" class="dropdown-item" data-interval="5 min">
                        <i class="bi bi-clock me-2"></i>5 minutes
                    </a></li>
                    <li><a href="#" class="dropdown-item" data-interval="10 min">
                        <i class="bi bi-clock me-2"></i>10 minutes
                    </a></li>
                    <li><a href="#" class="dropdown-item" data-interval="30 min">
                        <i class="bi bi-clock me-2"></i>30 minutes
                    </a></li>
                    <li><a href="#" class="dropdown-item" data-interval="1 hr">
                        <i class="bi bi-clock me-2"></i>1 hour
                    </a></li>
                `;
                setupAutoSyncDropdown(); // Re-setup event listeners
            }

            function updateDropdownForActiveState() {
                const dropdown = document.querySelector('#emailActionsDropdown + .dropdown-menu');
                dropdown.innerHTML = `
                    <li><h6 class="dropdown-header">Sync Interval</h6></li>
                    <li><a href="#" class="dropdown-item" data-interval="5 min">
                        <i class="bi bi-clock me-2"></i>5 minutes
                    </a></li>
                    <li><a href="#" class="dropdown-item" data-interval="10 min">
                        <i class="bi bi-clock me-2"></i>10 minutes
                    </a></li>
                    <li><a href="#" class="dropdown-item" data-interval="30 min">
                        <i class="bi bi-clock me-2"></i>30 minutes
                    </a></li>
                    <li><a href="#" class="dropdown-item" data-interval="1 hr">
                        <i class="bi bi-clock me-2"></i>1 hour
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a href="#" class="dropdown-item text-danger" onclick="pauseAutoSync()">
                        <i class="bi bi-pause-circle me-2"></i>Pause Auto Sync
                    </a></li>
                `;
                setupAutoSyncDropdown(); // Re-setup event listeners
            }

            // Quiet version of Gmail sync for auto sync (no success notifications)
            async function syncGmailEmailsQuietly() {
                try {
                    // First check Gmail status
                    const statusResponse = await fetch('/api/gmail/status');
                    const statusData = await statusResponse.json();

                    if (!statusData.connected) {
                        console.log('Gmail not connected, skipping auto sync');
                        return;
                    }

                    // Sync emails from Gmail
                    const syncResponse = await fetch('/api/gmail/sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            maxResults: 50,
                            query: ''
                        })
                    });

                    if (syncResponse.ok) {
                        const syncData = await syncResponse.json();
                        console.log(`Auto sync completed: ${syncData.syncedCount} emails synced`);
                        
                        // Refresh email list quietly
                        const filter = document.getElementById('emailFilter').value;
                        const search = document.getElementById('emailSearch').value;
                        loadEmails(filter, search);
                    }

                } catch (error) {
                    console.error('Auto sync error:', error);
                }
            }

            async function loadEmails(filter = '', search = '') {
                console.log('Loading emails with filter:', filter, 'search:', search);
                const emailLoading = document.getElementById('emailLoading');
                const emailEmpty = document.getElementById('emailEmpty');
                const emailCount = document.getElementById('emailCount');

                // Show loading
                if (emailLoading) emailLoading.style.display = 'block';
                if (emailEmpty) emailEmpty.style.display = 'none';

                try {
                    const params = new URLSearchParams();
                    if (filter) params.append('filter', filter);
                    if (search) params.append('search', search);

                    const response = await fetch(`/api/emails?${params.toString()}`);
                    const data = await response.json();
                    console.log('Loaded emails response:', data);

                    if (data.success) {
                        emails = data.emails;
                        console.log('Emails loaded:', emails.length);
                        displayEmails(emails);
                        if (emailCount) emailCount.textContent = emails.length;
                    } else {
                        throw new Error(data.message || 'Failed to load emails');
                    }
                } catch (error) {
                    console.error('Error loading emails:', error);
                    showError('Failed to load emails. Please try again.');
                } finally {
                    if (emailLoading) emailLoading.style.display = 'none';
                }
            }

            function displayEmails(emailsToShow) {
                console.log('Displaying emails:', emailsToShow.length);
                const emailList = document.getElementById('emailList');
                const emailEmpty = document.getElementById('emailEmpty');
                const emailLoading = document.getElementById('emailLoading');

                if (!emailList) {
                    console.error('Email list element not found!');
                    return;
                }

                // Clear existing emails (except loading and empty states)
                const existingEmails = emailList.querySelectorAll('.email-item');
                existingEmails.forEach(email => email.remove());

                if (emailsToShow.length === 0) {
                    if (emailEmpty) emailEmpty.style.display = 'block';
                    if (emailLoading) emailLoading.style.display = 'none';
                    return;
                }

                if (emailEmpty) emailEmpty.style.display = 'none';
                if (emailLoading) emailLoading.style.display = 'none';

                emailsToShow.forEach(email => {
                    const emailItem = document.createElement('div');
                    emailItem.className = `email-item ${!email.is_read ? 'email-unread' : 'email-read'}`;
                    emailItem.dataset.emailId = email._id || email.id; // Use MongoDB _id or fallback to id
                    
                    const emailDate = email.received_at ? new Date(email.received_at) : new Date(email.created_at);
                    const timeAgo = getTimeAgo(emailDate);

                    emailItem.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-1 text-center">
                                <div class="email-avatar">
                                    <div class="avatar-circle">
                                        <span class="avatar-text">${email.sender_email.charAt(0).toUpperCase()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-8">
                                <div class="email-content">
                                    <div class="d-flex align-items-center mb-1">
                                        <strong class="email-sender me-2 ${!email.is_read ? 'text-primary' : 'text-body'}">${escapeHtml(email.sender_email)}</strong>
                                        <div class="email-badges">
                                            ${email.is_important ? '<span class="badge bg-warning text-dark me-1"><i class="bi bi-star-fill me-1"></i>Important</span>' : ''}
                                            ${!email.is_read ? '<span class="badge bg-primary me-1"><i class="bi bi-envelope me-1"></i>New</span>' : ''}
                                            ${email.gmail_message_id ? '<span class="badge bg-info me-1"><i class="bi bi-google me-1"></i>Gmail</span>' : '<span class="badge bg-secondary me-1"><i class="bi bi-house me-1"></i>Local</span>'}
                                        </div>
                                    </div>
                                    <h6 class="email-subject mb-1 ${!email.is_read ? 'fw-bold' : ''}">${escapeHtml(email.subject)}</h6>
                                    <p class="email-preview mb-0 text-muted">${getEmailPreview(email.body, 120)}</p>
                                </div>
                            </div>
                            <div class="col-2 text-center">
                                <div class="email-time">
                                    <small class="text-muted d-block">${timeAgo}</small>
                                    <small class="text-muted">${emailDate.toLocaleDateString()}</small>
                                </div>
                            </div>
                            <div class="col-1">
                                <div class="email-actions">
                                    <div class="btn-group-vertical btn-group-sm">
                                        <button class="btn btn-outline-warning btn-sm mb-1 star-btn" data-email-id="${email._id || email.id}" data-is-important="${email.is_important}" title="${email.is_important ? 'Remove from important' : 'Mark as important'}">
                                            <i class="bi bi-star${email.is_important ? '-fill' : ''}"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm delete-btn" data-email-id="${email._id || email.id}" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Add click event for the email item
                    emailItem.addEventListener('click', function(e) {
                        console.log('Email item clicked', e.target);
                        // Don't trigger if clicking on buttons
                        if (!e.target.closest('.email-actions')) {
                            const emailId = this.dataset.emailId; // Get email ID from dataset (MongoDB uses strings)
                            console.log('Opening email with ID:', emailId, typeof emailId);
                            if (emailId && emailId !== 'undefined') {
                                viewEmail(emailId); // Don't parse as int, keep as string for MongoDB
                            } else {
                                console.error('Email ID not found or undefined');
                            }
                        } else {
                            console.log('Clicked on email actions, not opening email');
                        }
                    });

                    // Add event listeners for action buttons
                    const starBtn = emailItem.querySelector('.star-btn');
                    const deleteBtn = emailItem.querySelector('.delete-btn');

                    if (starBtn) {
                        starBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            console.log('Star button clicked');
                            const emailId = this.dataset.emailId; // Don't parse as int since MongoDB uses strings
                            const isImportant = this.dataset.isImportant === 'true';
                            toggleImportant(emailId, !isImportant);
                        });
                    }

                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            console.log('Delete button clicked');
                            const emailId = this.dataset.emailId; // Don't parse as int since MongoDB uses strings
                            deleteEmailById(emailId);
                        });
                    }

                    emailList.insertBefore(emailItem, emailLoading);
                });
            }

            function getTimeAgo(date) {
                const now = new Date();
                const emailDate = new Date(date);
                const diffInMinutes = Math.floor((now - emailDate) / (1000 * 60));

                // Handle edge cases where time might be negative (future dates) or very small
                if (diffInMinutes < 0) {
                    return 'just now';
                } else if (diffInMinutes === 0) {
                    return 'just now';
                } else if (diffInMinutes < 60) {
                    return `${diffInMinutes}m ago`;
                } else if (diffInMinutes < 1440) {
                    return `${Math.floor(diffInMinutes / 60)}h ago`;
                } else {
                    return `${Math.floor(diffInMinutes / 1440)}d ago`;
                }
            }

            function refreshEmails() {
                const filter = document.getElementById('emailFilter').value;
                const search = document.getElementById('emailSearch').value;
                loadEmails(filter, search);
            }

            function filterEmails() {
                const filter = document.getElementById('emailFilter').value;
                const search = document.getElementById('emailSearch').value;
                loadEmails(filter, search);
            }

            function searchEmails() {
                const filter = document.getElementById('emailFilter').value;
                const search = document.getElementById('emailSearch').value;
                loadEmails(filter, search);
            }

            function composeEmail() {
                // Clear form
                document.getElementById('composeForm').reset();
            }

            async function syncGmailEmails() {
                const syncBtn = document.getElementById('gmailSyncBtn');
                const originalText = syncBtn.innerHTML;

                try {
                    // Show loading state
                    syncBtn.disabled = true;
                    syncBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i><span data-translate="email.syncing">Syncing...</span>';

                    // First check Gmail status
                    const statusResponse = await fetch('/api/gmail/status');
                    const statusData = await statusResponse.json();

                    if (!statusData.connected) {
                        throw new Error('Gmail integration not connected. Please set up Gmail integration first.');
                    }

                    // Sync emails from Gmail
                    const syncResponse = await fetch('/api/gmail/sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            maxResults: 50,
                            query: '' // Can be customized for specific queries
                        })
                    });

                    if (!syncResponse.ok) {
                        throw new Error(`Gmail sync failed: ${syncResponse.status}`);
                    }

                    const syncData = await syncResponse.json();

                    // Show success message
                    const successMsg = (typeof LanguageManager !== 'undefined' && LanguageManager.t) ? LanguageManager.t('email.gmailSyncSuccess') : `Successfully synced ${syncData.syncedCount} emails from Gmail`;

                    Swal.fire({
                        title: (typeof LanguageManager !== 'undefined' && LanguageManager.t) ? LanguageManager.t('email.syncComplete') : 'Sync Complete',
                        text: successMsg,
                        icon: 'success',
                        background: getSweetAlertTheme().background,
                        color: getSweetAlertTheme().color,
                        confirmButtonColor: getSweetAlertTheme().confirmButtonColor,
                        timer: 3000,
                        showConfirmButton: false
                    });

                    // Refresh email list
                    refreshEmails();

                } catch (error) {
                    console.error('Gmail sync error:', error);

                    let errorMessage = (typeof LanguageManager !== 'undefined' && LanguageManager.t) ? LanguageManager.t('email.gmailSyncError') : 'Failed to sync Gmail emails';
                    if (error.message.includes('not connected')) {
                        errorMessage = (typeof LanguageManager !== 'undefined' && LanguageManager.t) ? LanguageManager.t('email.gmailNotConnected') : 'Gmail integration not connected. Please set up Gmail integration in settings.';
                    }

                    Swal.fire({
                        title: (typeof LanguageManager !== 'undefined' && LanguageManager.t) ? LanguageManager.t('email.syncFailed') : 'Sync Failed',
                        text: errorMessage,
                        icon: 'error',
                        background: getSweetAlertTheme().background,
                        color: getSweetAlertTheme().color,
                        confirmButtonColor: getSweetAlertTheme().confirmButtonColor
                    });
                } finally {
                    // Reset button state
                    syncBtn.disabled = false;
                    syncBtn.innerHTML = originalText;
                }
            }

            // Function to reprocess attachments for existing emails
            async function reprocessAttachments() {
                const reprocessBtn = document.getElementById('reprocessBtn');
                const originalText = reprocessBtn.innerHTML;

                try {
                    // Show loading state
                    reprocessBtn.disabled = true;
                    reprocessBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Processing...';

                    // Call the reprocessing endpoint
                    const response = await fetch('/api/gmail/reprocess-attachments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Reprocessing failed: ${response.status}`);
                    }

                    const result = await response.json();

                    // Show success message
                    await safeSwal({
                        title: 'Attachments Reprocessed!',
                        text: `Found ${result.totalAttachments} attachments in ${result.processedEmails} emails`,
                        icon: 'success',
                        background: getSweetAlertTheme().background,
                        color: getSweetAlertTheme().color,
                        confirmButtonColor: getSweetAlertTheme().confirmButtonColor
                    });

                    // Refresh the current email view if one is selected
                    if (currentEmail && (currentEmail._id || currentEmail.id)) {
                        viewEmail(currentEmail._id || currentEmail.id);
                    }

                } catch (error) {
                    console.error('Attachment reprocessing error:', error);
                    const errorMessage = error.message || 'Failed to reprocess attachments';

                    await safeSwal({
                        title: 'Reprocessing Failed',
                        text: errorMessage,
                        icon: 'error',
                        background: getSweetAlertTheme().background,
                        color: getSweetAlertTheme().color,
                        confirmButtonColor: getSweetAlertTheme().confirmButtonColor
                    });
                } finally {
                    // Reset button state
                    reprocessBtn.disabled = false;
                    reprocessBtn.innerHTML = originalText;
                }
            }

            async function checkGmailStatus() {
                try {
                    const response = await fetch('/api/gmail/status');
                    const data = await response.json();

                    const statusMessage = document.getElementById('gmailStatusMessage');
                    const integrationAlert = document.getElementById('gmailIntegrationAlert');
                    const connectBtn = document.getElementById('gmailConnectBtn');
                    const connectedBtn = document.getElementById('gmailConnectedBtn');
                    const disconnectBtn = document.getElementById('gmailDisconnectBtn');
                    const syncBtn = document.getElementById('gmailSyncBtn');

                    if (data.connected) {
                        statusMessage.textContent = `Connected as ${data.gmailEmail || 'Gmail account'}`;
                        integrationAlert.className = 'alert alert-success d-flex align-items-center';
                        integrationAlert.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>
                    <div>Connected as ${data.gmailEmail || 'Gmail account'}</div>
                `;

                        connectBtn.style.display = 'none';
                        connectedBtn.style.display = 'inline-block';
                        disconnectBtn.style.display = 'inline-block';
                        syncBtn.style.display = 'inline-block';
                        syncBtn.disabled = false;
                    } else {
                        statusMessage.textContent = 'Gmail not connected';
                        integrationAlert.className = 'alert alert-warning d-flex align-items-center';
                        integrationAlert.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <div>Gmail not connected. Please connect your Gmail account to sync emails.</div>
                `;

                        connectBtn.style.display = 'inline-block';
                        connectedBtn.style.display = 'none';
                        disconnectBtn.style.display = 'none';
                        syncBtn.style.display = 'none';
                        syncBtn.disabled = true;
                    }
                } catch (error) {
                    console.error('Error checking Gmail status:', error);
                    const statusMessage = document.getElementById('gmailStatusMessage');
                    const integrationAlert = document.getElementById('gmailIntegrationAlert');

                    statusMessage.textContent = 'Error checking Gmail status';
                    integrationAlert.className = 'alert alert-danger d-flex align-items-center';
                    integrationAlert.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                <div>Error checking Gmail status. Please try again.</div>
            `;
                }
            }

            function connectGmail() {
                // Redirect to Gmail OAuth authorization
                window.location.href = '/auth/google/gmail';
            }

            async function disconnectGmail() {
                try {
                    const result = await Swal.fire({
                        title: 'Disconnect Gmail?',
                        text: 'This will disable Gmail sync functionality.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'Yes, disconnect',
                        cancelButtonText: 'Cancel',
                        background: getSweetAlertTheme().background,
                        color: getSweetAlertTheme().color
                    });

                    if (result.isConfirmed) {
                        const response = await fetch('/api/gmail/disconnect', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            Swal.fire({
                                title: 'Disconnected!',
                                text: 'Gmail integration has been disconnected.',
                                icon: 'success',
                                background: getSweetAlertTheme().background,
                                color: getSweetAlertTheme().color,
                                confirmButtonColor: getSweetAlertTheme().confirmButtonColor,
                                timer: 2000,
                                showConfirmButton: false
                            });

                            // Update UI elements
                            const statusMessage = document.getElementById('gmailStatusMessage');
                            const integrationAlert = document.getElementById('gmailIntegrationAlert');
                            const connectBtn = document.getElementById('gmailConnectBtn');
                            const connectedBtn = document.getElementById('gmailConnectedBtn');
                            const disconnectBtn = document.getElementById('gmailDisconnectBtn');
                            const syncBtn = document.getElementById('gmailSyncBtn');

                            statusMessage.textContent = 'Gmail not connected';
                            integrationAlert.className = 'alert alert-warning d-flex align-items-center';
                            integrationAlert.innerHTML = `
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <div>Gmail not connected. Please connect your Gmail account to sync emails.</div>
                    `;

                            connectBtn.style.display = 'inline-block';
                            connectedBtn.style.display = 'none';
                            disconnectBtn.style.display = 'none';
                            syncBtn.style.display = 'none';
                            syncBtn.disabled = true;

                        } else {
                            throw new Error('Failed to disconnect Gmail');
                        }
                    }
                } catch (error) {
                    console.error('Error disconnecting Gmail:', error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to disconnect Gmail integration.',
                        icon: 'error',
                        background: getSweetAlertTheme().background,
                        color: getSweetAlertTheme().color,
                        confirmButtonColor: getSweetAlertTheme().confirmButtonColor
                    });
                }
            }

            async function sendEmail() {
                const to = document.getElementById('emailTo').value;
                const cc = document.getElementById('emailCc').value;
                const bcc = document.getElementById('emailBcc').value;
                const subject = document.getElementById('emailSubject').value;
                const body = document.getElementById('emailBody').value;
                const isImportant = document.getElementById('emailPriority').checked;

                if (!to || !subject || !body) {
                    showError('Please fill in all required fields.');
                    return;
                }

                try {
                    const response = await fetch('/api/emails', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            to,
                            cc: cc || null,
                            bcc: bcc || null,
                            subject,
                            body,
                            isImportant,
                            isDraft: false
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Email sent successfully!');

                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('composeModal'));
                        modal.hide();

                        // Clear form and refresh emails
                        document.getElementById('composeForm').reset();
                        refreshEmails();
                    } else {
                        throw new Error(data.message || 'Failed to send email');
                    }
                } catch (error) {
                    console.error('Error sending email:', error);
                    showError('Failed to send email. Please try again.');
                }
            }

            async function viewEmail(emailId) {
                console.log('viewEmail called with ID:', emailId, typeof emailId);
                if (!emailId || emailId === 'undefined' || emailId === 'null') {
                    console.error('No valid email ID provided to viewEmail');
                    showError('Invalid email ID');
                    return;
                }

                try {
                    const response = await fetch(`/api/emails/${emailId}`);
                    console.log('Email fetch response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Email data received:', data);

                    if (!data.success) {
                        throw new Error(data.message || 'Failed to load email');
                    }

                    const email = data.email;
                    currentEmail = email;

                    // Mark as read if unread
                    if (!email.is_read) {
                        await markAsRead(emailId, true);
                        // Update local data
                        const emailIndex = emails.findIndex(e => (e._id || e.id) === emailId);
                        if (emailIndex !== -1) {
                            emails[emailIndex].is_read = true;
                            displayEmails(emails); // Refresh display
                        }
                    }

                    // Update important button state
                    const importantIcon = document.getElementById('modalImportantIcon');
                    const importantText = document.getElementById('modalImportantText');
                    if (email.is_important) {
                        importantIcon.className = 'bi bi-star-fill me-2 text-warning';
                        importantText.textContent = 'Remove Important';
                    } else {
                        importantIcon.className = 'bi bi-star me-2';
                        importantText.textContent = 'Mark Important';
                    }

                    const emailViewContent = document.getElementById('emailViewContent');
                    // Use received_at if available, otherwise fall back to created_at
                    const emailDate = email.received_at ? new Date(email.received_at) : new Date(email.created_at);
                    const timeAgo = getTimeAgo(emailDate);

                    // Fetch attachments for this email
                    let attachments = [];
                    try {
                        const attachmentResponse = await fetch(`/api/emails/${emailId}/attachments`);
                        const attachmentData = await attachmentResponse.json();
                        if (attachmentData.success) {
                            attachments = attachmentData.attachments;
                        }
                    } catch (attachmentError) {
                        console.error('Error fetching attachments:', attachmentError);
                    }

                                        // Format email body with clickable links and better formatting
                                        const formattedBody = formatEmailBody(email.body);

                                        // prefer MongoDB _id if present
                                        const emailIdForLinks = String(email._id || email.id || '');

                                        emailViewContent.innerHTML = `
                                <!-- Email Header Card -->
                                <div class="email-view-header p-4">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div class="flex-grow-1">
                                                        <h3 class="mb-2 fw-bold email-subject">${escapeHtml(email.subject || (LanguageManager && LanguageManager.get ? LanguageManager.get('No Subject') : 'No Subject'))}</h3>
                                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                                                ${email.is_important ? '<span class="badge bg-warning text-dark shadow-sm"><i class="bi bi-star-fill me-1"></i>Important</span>' : ''}
                                                                ${!email.is_read ? '<span class="badge bg-primary shadow-sm"><i class="bi bi-circle-fill me-1"></i>Unread</span>' : '<span class="badge bg-success shadow-sm"><i class="bi bi-check-circle-fill me-1"></i>Read</span>'}
                                                                ${email.gmail_message_id ? '<span class="badge bg-info shadow-sm"><i class="bi bi-google me-1"></i>Gmail</span>' : '<span class="badge bg-secondary shadow-sm"><i class="bi bi-envelope me-1"></i>Local</span>'}
                                                        </div>
                                                </div>
                                                <div class="text-end text-muted small" style="min-width:160px;">
                                                        <div class="text-primary fw-medium mb-1">${timeAgo}</div>
                                                        <div>${emailDate.toLocaleDateString([], { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</div>
                                                        <div>${emailDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                                                </div>
                                        </div>

                                        <div class="email-source-card mt-3 p-3 rounded-3">
                                                <div class="d-flex align-items-center">
                                                        <div class="me-3">
                                                                ${email.gmail_message_id ? '<i class="bi bi-google fs-4 text-info"></i>' : '<i class="bi bi-envelope-fill fs-4 text-secondary"></i>'}
                                                        </div>
                                                        <div class="flex-grow-1">
                                                                <div class="fw-bold mb-1">${email.gmail_message_id ? 'Gmail Integration' : 'Local Email System'}</div>
                                                                <div class="text-muted small">${email.gmail_message_id ? 'This email was synced from your Gmail account via Google API' : 'This email was created locally using the internal email system'}</div>
                                                                ${email.gmail_message_id ? `<div class="text-muted small mt-1"><i class="bi bi-hash me-1"></i>Gmail ID: <code class="small">${escapeHtml(email.gmail_message_id)}</code></div>` : ''}
                                                        </div>
                                                        <div class="text-end">
                                                                <span class="badge ${email.gmail_message_id ? 'bg-info' : 'bg-secondary'} rounded-pill">${email.gmail_message_id ? 'External' : 'Internal'}</span>
                                                        </div>
                                                </div>
                                        </div>
                                </div>

                                <div class="p-4">
                                    <div class="d-flex gap-3 mb-3">
                                        <div class="sender-info-card p-3 rounded-3">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle me-3">
                                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center avatar-fixed-size">
                                                        <span class="fw-bold fs-4">${escapeHtml((email.sender_email || '').charAt(0).toUpperCase() || '')}</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">${escapeHtml(email.sender_email)}</div>
                                                    <div class="text-muted small d-flex align-items-center">
                                                        <i class="bi bi-arrow-right me-2 text-primary"></i>
                                                        <span class="me-1">to</span>
                                                        <a href="mailto:${email.recipient_email}" class="email-link text-decoration-none">${escapeHtml(email.recipient_email)}</a>
                                                    </div>
                                                    ${email.cc_emails ? `<div class="text-muted small mt-1">cc <a href="mailto:${email.cc_emails}" class="email-link text-decoration-none">${escapeHtml(email.cc_emails)}</a></div>` : ''}
                                                </div>
                                                <div class="ms-auto">
                                                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${email.sender_email}')" title="Copy sender email"><i class="bi bi-copy"></i></button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex-grow-1">
                                            <div class="email-body-card p-3 mt-0">
                                                <div id="emailBodyContainer" class="email-body-formatting" data-has-html="${/<[^>]+>/g.test(email.body)}"></div>
                                            </div>
                                            <div class="mt-3 d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" onclick="copyEmailContent()"><i class="bi bi-clipboard me-1"></i>${LanguageManager && LanguageManager.get ? LanguageManager.get('Copy Content') : 'Copy Content'}</button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="printEmail()"><i class="bi bi-printer me-1"></i>${LanguageManager && LanguageManager.get ? LanguageManager.get('Print') : 'Print'}</button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="shareEmail()"><i class="bi bi-share me-1"></i>${LanguageManager && LanguageManager.get ? LanguageManager.get('Share') : 'Share'}</button>
                                            </div>
                                        </div>
                                    </div>

                                    ${attachments.length > 0 ? `
                                    <div class="attachments-section mt-3">
                                        <h5 class="mb-3"><i class="bi bi-paperclip text-primary me-2"></i> ${LanguageManager && LanguageManager.get ? LanguageManager.get('Attachments') : 'Attachments'} (${attachments.length})</h5>
                                        <div class="row g-3">
                                            ${attachments.map(attachment => {
                                                const isImage = attachment.mime_type && attachment.mime_type.startsWith && attachment.mime_type.startsWith('image/');
                                                const fileSize = formatFileSize(attachment.size_bytes);
                                                if (isImage) {
                                                    return `
                                                    <div class="col-md-6 col-lg-4">
                                                        <div class="attachment-item border rounded-3 p-3 h-100">
                                                            <div class="mb-3">
                                                                <img src="/api/emails/${emailIdForLinks}/attachments/${attachment.id}" 
                                                                         alt="${escapeHtml(attachment.filename)}"
                                                                         class="img-fluid rounded shadow-sm attachment-image-preview"
                                                                         onclick="viewImageFullscreen('/api/emails/${emailIdForLinks}/attachments/${attachment.id}', '${escapeHtml(attachment.filename)}')"
                                                                         loading="lazy">
                                                            </div>
                                                            <div>
                                                                <div class="fw-bold text-truncate" title="${escapeHtml(attachment.filename)}">${escapeHtml(attachment.filename)}</div>
                                                                <small class="text-muted">${fileSize}</small>
                                                            </div>
                                                            <div class="mt-2">
                                                                <a href="/api/emails/${emailIdForLinks}/attachments/${attachment.id}" download="${escapeHtml(attachment.filename)}" class="btn btn-sm btn-outline-primary"><i class="bi bi-download me-1"></i>Download</a>
                                                            </div>
                                                        </div>
                                                    </div>`;
                                                } else {
                                                    return `
                                                    <div class="col-md-6 col-lg-4">
                                                        <div class="attachment-item border rounded-3 p-3 h-100">
                                                            <div class="mb-3"><i class="bi bi-file-earmark fs-1 text-secondary"></i></div>
                                                            <div>
                                                                <div class="fw-bold text-truncate" title="${escapeHtml(attachment.filename)}">${escapeHtml(attachment.filename)}</div>
                                                                <small class="text-muted">${fileSize}  ${escapeHtml(attachment.mime_type)}</small>
                                                            </div>
                                                            <div class="mt-2">
                                                                <a href="/api/emails/${emailIdForLinks}/attachments/${attachment.id}" download="${escapeHtml(attachment.filename)}" class="btn btn-sm btn-outline-primary"><i class="bi bi-download me-1"></i>Download</a>
                                                            </div>
                                                        </div>
                                                    </div>`;
                                                }
                                            }).join('')}
                                        </div>
                                    </div>
                                    ` : ''}

                                    <div class="email-metadata-card mt-4 p-3 rounded-3">
                                        <div class="row g-3">
                                            <div class="col-lg-2 col-md-4 col-6">
                                                <div class="border rounded-3 p-3 h-100">
                                                    <i class="bi bi-eye${email.is_read ? '' : '-slash'} text-${email.is_read ? 'success' : 'warning'} fs-4 mb-2"></i>
                                                    <div class="text-muted small">Status</div>
                                                    <div class="fw-bold">${email.is_read ? 'Read' : 'Unread'}</div>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-md-4 col-6">
                                                <div class="border rounded-3 p-3 h-100">
                                                    <i class="bi bi-star${email.is_important ? '-fill' : ''} text-${email.is_important ? 'warning' : 'muted'} fs-4 mb-2"></i>
                                                    <div class="text-muted small">Priority</div>
                                                    <div class="fw-bold">${email.is_important ? 'Important' : 'Normal'}</div>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-md-4 col-6">
                                                <div class="border rounded-3 p-3 h-100">
                                                    <i class="bi bi-person-check-fill text-success fs-4 mb-2"></i>
                                                    <div class="text-muted small">Recipient</div>
                                                    <div class="fw-bold text-truncate" title="${escapeHtml(email.recipient_email)}">${escapeHtml((email.recipient_email || '').split('@')[0] || '')}</div>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-md-4 col-6">
                                                <div class="border rounded-3 p-3 h-100">
                                                    <i class="bi bi-${email.gmail_message_id ? 'google' : 'envelope'} text-${email.gmail_message_id ? 'info' : 'secondary'} fs-4 mb-2"></i>
                                                    <div class="text-muted small">Source</div>
                                                    <div class="fw-bold">${email.gmail_message_id ? 'Gmail' : 'Local'}</div>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-md-4 col-6">
                                                <div class="border rounded-3 p-3 h-100">
                                                    <i class="bi bi-hash text-primary fs-4 mb-2"></i>
                                                    <div class="text-muted small">ID</div>
                                                    <div class="fw-bold text-truncate">#${escapeHtml(emailIdForLinks)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        `;

                                        const modal = new bootstrap.Modal(document.getElementById('emailViewModal'));
                                        modal.show();

                                        // After modal content is inserted, render body with no client-side parsing.
                                        (function renderBodyMinimal() {
                                            const bodyContainer = document.getElementById('emailBodyContainer');
                                            const toggleBtn = document.getElementById('emailViewToggleRenderBtn');
                                            if (toggleBtn) toggleBtn.style.display = 'none'; // Disable toggle since parsing removed
                                            if (!bodyContainer) return;

                                            // If server provided explicit HTML, embed it directly in a sandboxed iframe.
                                            const htmlContent = email.htmlBody || email.body;
                                            if (htmlContent && /<[^>]+>/g.test(htmlContent)) {
                                                renderEmailThemeInIframe(bodyContainer, htmlContent);
                                                // enable toggle so user can switch to original view
                                                try { setupEmailRenderToggle(bodyContainer, htmlContent); } catch (e) { console.error('setupEmailRenderToggle failed', e); }
                                            } else {
                                                // Plain text: escape and preserve newlines
                                                bodyContainer.innerHTML = escapeHtml(email.body || '').replace(/\n/g, '<br>');
                                            }
                                        })();

                                        // Minimal iframe renderer that does not parse or sanitize the HTML.
                                        function renderEmailThemeInIframe(container, html) {
                                            try {
                                                container.innerHTML = '';

                                                // Determine site theme via data-bs-theme or .dark class
                                                let theme = document.documentElement.getAttribute('data-bs-theme');
                                                if (!theme) theme = (document.documentElement.classList.contains('dark') || document.body.classList.contains('dark')) ? 'dark' : 'light';

                                                // For dark site theme use a neutral dark gray background and light text (no blue tint)
                                                const bg = theme === 'dark' ? '#212529;' : '#ffffff';
                                                const text = theme === 'dark' ? '#dee2e6' : '#111827';
                                                const link = theme === 'dark' ? '#8ab4ff' : '#1a73e8';

                                                const injected = `<style>
                                                    :root{--iframe-bg:${bg};--iframe-text:${text};--iframe-link:${link}}
                                                    /* Force neutral background and readable text for theme view */
                                                    html,body, * { margin:0; padding:0; background:var(--iframe-bg) !important; color:var(--iframe-text) !important; border-color: rgba(255,255,255,0.06) !important }
                                                    :where(table,td,th){ background:transparent !important }
                                                    html,body{padding:12px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial}
                                                    img{max-width:100% !important;height:auto !important;display:block;margin:0 auto}
                                                    table{max-width:100% !important;width:100% !important;border-collapse:collapse}
                                                    a{color:var(--iframe-link) !important}
                                                </style>`;

                                                const srcdoc = '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">' + injected + '</head><body><div>' + html + '</div></body></html>';

                                                const iframe = document.createElement('iframe');
                                                iframe.className = 'email-iframe border-0 rounded-2';
                                                iframe.setAttribute('sandbox', '');
                                                iframe.setAttribute('scrolling', 'auto');
                                                iframe.style.width = '100%';
                                                iframe.style.minHeight = '60vh';
                                                iframe.style.border = '0';
                                                iframe.srcdoc = srcdoc;

                                                container.appendChild(iframe);
                                            } catch (err) {
                                                console.error('Failed to render HTML in iframe', err);
                                                container.innerText = html;
                                            }
                                        }
                } catch (error) {
                    console.error('Error viewing email:', error);
                    showError('Failed to load email. Please try again.');
                }
            }

            async function markAsRead(emailId, isRead) {
                try {
                    const response = await fetch(`/api/emails/${emailId}/read`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ isRead })
                    });

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to update email');
                    }
                } catch (error) {
                    console.error('Error updating email read status:', error);
                }
            }

            async function toggleImportant(emailId, isImportant) {
                try {
                    const response = await fetch(`/api/emails/${emailId}/important`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ isImportant })
                    });

                    const data = await response.json();
                    if (data.success) {
                        // Update local data
                        const emailIndex = emails.findIndex(e => (e._id || e.id) === emailId);
                        if (emailIndex !== -1) {
                            emails[emailIndex].is_important = isImportant;
                            displayEmails(emails); // Refresh display
                        }
                        showSuccess(isImportant ? 'Email marked as important' : 'Email unmarked as important');
                    } else {
                        throw new Error(data.message || 'Failed to update email');
                    }
                } catch (error) {
                    console.error('Error updating email importance:', error);
                    showError('Failed to update email importance.');
                }
            }

            async function toggleImportantFromModal() {
                if (!currentEmail) return;

                const newImportantState = !currentEmail.is_important;
                await toggleImportant(currentEmail._id || currentEmail.id, newImportantState);

                // Update current email object and modal UI
                currentEmail.is_important = newImportantState;
                const importantIcon = document.getElementById('modalImportantIcon');
                const importantText = document.getElementById('modalImportantText');

                if (newImportantState) {
                    importantIcon.className = 'bi bi-star-fill me-2 text-warning';
                    importantText.textContent = 'Remove Important';
                } else {
                    importantIcon.className = 'bi bi-star me-2';
                    importantText.textContent = 'Mark Important';
                }
            }

            async function deleteEmailById(emailId) {
                const confirmed = await Swal.fire({
                    title: 'Delete Email?',
                    text: 'Are you sure you want to delete this email? This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: getThemeColor('danger'),
                    cancelButtonColor: getThemeColor('secondary'),
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel',
                    background: getSweetAlertTheme().background,
                    color: getSweetAlertTheme().color
                });

                if (!confirmed.isConfirmed) {
                    return;
                }

                try {
                    const response = await fetch(`/api/emails/${emailId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    if (data.success) {
                        // Remove from local data
                        emails = emails.filter(email => (email._id || email.id) !== emailId);
                        displayEmails(emails);
                        document.getElementById('emailCount').textContent = emails.length;
                        showSuccess('Email deleted successfully');
                    } else {
                        throw new Error(data.message || 'Failed to delete email');
                    }
                } catch (error) {
                    console.error('Error deleting email:', error);
                    showError('Failed to delete email. Please try again.');
                }
            }

            async function deleteEmail() {
                if (!currentEmail) return;

                const confirmed = await Swal.fire({
                    title: 'Delete Email?',
                    text: 'Are you sure you want to delete this email? This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: getThemeColor('danger'),
                    cancelButtonColor: getThemeColor('secondary'),
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel',
                    background: getSweetAlertTheme().background,
                    color: getSweetAlertTheme().color
                });

                    if (confirmed.isConfirmed) {
                    await deleteEmailById(currentEmail._id || currentEmail.id);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('emailViewModal'));
                    modal.hide();
                }
            }

            function replyToEmail() {
                if (currentEmail) {
                    // Use received_at if available, otherwise fall back to created_at
                    const emailDate = currentEmail.received_at ? new Date(currentEmail.received_at) : new Date(currentEmail.created_at);
                    document.getElementById('emailTo').value = currentEmail.sender_email;
                    document.getElementById('emailSubject').value = 'Re: ' + currentEmail.subject;
                    document.getElementById('emailBody').value = `\n\n--- Original Message ---\nFrom: ${currentEmail.sender_email}\nSubject: ${currentEmail.subject}\nDate: ${emailDate.toLocaleString()}\n\n${currentEmail.body}`;

                    const viewModal = bootstrap.Modal.getInstance(document.getElementById('emailViewModal'));
                    viewModal.hide();

                    const composeModal = new bootstrap.Modal(document.getElementById('composeModal'));
                    composeModal.show();
                }
            }

            function forwardEmail() {
                if (currentEmail) {
                    // Use received_at if available, otherwise fall back to created_at
                    const emailDate = currentEmail.received_at ? new Date(currentEmail.received_at) : new Date(currentEmail.created_at);
                    document.getElementById('emailSubject').value = 'Fwd: ' + currentEmail.subject;
                    document.getElementById('emailBody').value = `\n\n--- Forwarded Message ---\nFrom: ${currentEmail.sender_email}\nTo: ${currentEmail.recipient_email}\nSubject: ${currentEmail.subject}\nDate: ${emailDate.toLocaleString()}\n\n${currentEmail.body}`;

                    const viewModal = bootstrap.Modal.getInstance(document.getElementById('emailViewModal'));
                    viewModal.hide();

                    const composeModal = new bootstrap.Modal(document.getElementById('composeModal'));
                    composeModal.show();
                }
            }

            // Helper functions for notifications
            function showSuccess(message) {
                safeSwal({
                    title: 'Success!',
                    text: message,
                    icon: 'success',
                    background: getSweetAlertTheme().background,
                    color: getSweetAlertTheme().color,
                    confirmButtonColor: getSweetAlertTheme().confirmButtonColor,
                    timer: 3000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }

            function showError(message) {
                safeSwal({
                    title: 'Error!',
                    text: message,
                    icon: 'error',
                    background: getSweetAlertTheme().background,
                    color: getSweetAlertTheme().color,
                    confirmButtonColor: getSweetAlertTheme().confirmButtonColor
                });
            }

            // Enhanced email formatting functions
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function stripHtmlTags(html) {
                if (!html) return '';
                // Create a temporary div to parse HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                // Get text content and clean up extra whitespace
                return tempDiv.textContent || tempDiv.innerText || '';
            }

            function getEmailPreview(body, maxLength = 120) {
                if (!body) return '';
                // Strip HTML tags first, then escape for display, then truncate
                const cleanText = stripHtmlTags(body);
                const truncated = cleanText.substring(0, maxLength);
                return escapeHtml(truncated) + (cleanText.length > maxLength ? '...' : '');
            }

            function formatEmailBody(body) {
                if (!body) return '';

                // Check if the body contains HTML content
                const hasHtmlTags = /<[^>]+>/g.test(body);

                if (hasHtmlTags) {
                    // If it's HTML, preserve the original structure with minimal cleaning
                    // Only fix basic encoding issues, don't strip HTML
                    let formattedBody = body
                        // Fix common HTML entities
                        .replace(/&nbsp;/g, ' ')
                        .replace(/&amp;/g, '&')
                        .replace(/&lt;/g, '<')
                        .replace(/&gt;/g, '>')
                        .replace(/&quot;/g, '"')
                        .replace(/&#39;/g, "'")
                        .replace(/&apos;/g, "'")
                        // Decode basic URL encoding if present
                        .replace(/%20/g, ' ')
                        .replace(/%3A/g, ':')
                        .replace(/%2F/g, '/')
                        .replace(/%3F/g, '?')
                        .replace(/%3D/g, '=')
                        .replace(/%26/g, '&');

                    // Return the HTML as-is to preserve buttons, cards, and styling
                    return formattedBody;
                } else {
                    // If it's plain text, escape it and preserve line breaks
                    let formattedBody = escapeHtml(body)
                        .replace(/\n/g, '<br>');

                    // Make URLs clickable in plain text
                    const urlRegex = /(https?:\/\/[^\s<>"&]+)/gi;
                    formattedBody = formattedBody.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" class="email-link">$1</a>');

                    // Make email addresses clickable in plain text
                    const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi;
                    formattedBody = formattedBody.replace(emailRegex, '<a href="mailto:$1" class="email-link">$1</a>');

                    return formattedBody;
                }
            }
            
                        // Render HTML safely inside a sandboxed iframe using srcdoc
                        // Sanitize HTML for theme-adapted rendering (remove inline backgrounds/colors that force light mode)
                        function sanitizeHtmlForTheme(html, theme) {
                            try {
                                if (!html || theme !== 'dark') return html; // only sanitize for dark theme
                                const parser = new DOMParser();
                                // Parse as HTML (works for fragments and full docs)
                                const doc = parser.parseFromString(html, 'text/html');

                                // Remove meta tags that force color schemes
                                doc.querySelectorAll('meta[name="color-scheme"], meta[name="theme-color"]').forEach(m => m.remove());

                                // Walk elements and remove inline background / color declarations and bgcolor/bg attributes
                                const all = doc.querySelectorAll('*');
                                all.forEach(el => {
                                    if (el.hasAttribute('bgcolor')) el.removeAttribute('bgcolor');
                                    if (el.hasAttribute('bg')) el.removeAttribute('bg');

                                    // Clean style attribute: remove background/background-color/color declarations and !important
                                    if (el.hasAttribute('style')) {
                                        let s = el.getAttribute('style') || '';
                                        // Remove background / background-color / color declarations (with optional !important)
                                        s = s.replace(/(?:background(?:-color)?|color)\s*:\s*[^;]+;?/gi, '');
                                        // Also remove background-image declarations
                                        s = s.replace(/background-image\s*:\s*[^;]+;?/gi, '');
                                        // Remove any remaining !important tokens
                                        s = s.replace(/!important/gi, '');
                                        s = s.trim();
                                        if (s) {
                                            el.setAttribute('style', s);
                                        } else {
                                            el.removeAttribute('style');
                                        }
                                    }
                                });

                                // Aggressively clean <style> blocks inside the email (remove color/background rules)
                                const styleEls = doc.querySelectorAll('style');
                                styleEls.forEach(styleEl => {
                                    try {
                                        let css = styleEl.textContent || '';
                                        // Remove background, background-image, background-color, and color declarations
                                        css = css.replace(/(?:background(?:-image|-color)?|color)\s*:\s*[^;]+;?/gi, '');
                                        // Remove gradients and images references
                                        css = css.replace(/url\([^\)]+\)\s*;?/gi, '');
                                        // Remove !important tokens
                                        css = css.replace(/!important/gi, '');
                                        // Collapse multiple semicolons and clean up empty rules
                                        css = css.replace(/;\s*;/g, ';');
                                        css = css.replace(/\s*\{\s*\}/g, '');
                                        styleEl.textContent = css;
                                    } catch (e) {
                                        // If parsing fails, remove the style element as a fallback
                                        try { styleEl.remove(); } catch (er) { }
                                    }
                                });

                                // Serialize back to string. If original was a fragment, return body innerHTML; otherwise full document.
                                const looksLikeDoc = /<!doctype|<html/i.test(html);
                                if (looksLikeDoc) {
                                    return '<!doctype html>' + doc.documentElement.outerHTML;
                                } else {
                                    return doc.body ? doc.body.innerHTML : html;
                                }
                            } catch (err) {
                                console.error('sanitizeHtmlForTheme failed', err);
                                return html;
                            }
                        }

                        function renderEmailHtmlInIframe(container, html) {
                                try {
                                        container.innerHTML = '';

                                        // Robust theme detection: data-bs-theme, .dark class, body class, or prefers-color-scheme
                                        let theme = document.documentElement.getAttribute('data-bs-theme');
                                        if (!theme) {
                                            if (document.documentElement.classList.contains('dark') || document.body.classList.contains('dark')) {
                                                theme = 'dark';
                                            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                                theme = 'dark';
                                            } else {
                                                theme = 'light';
                                            }
                                        }

                                        // If the html is escaped (contains &lt;), decode it first
                                        const decoder = document.createElement('textarea');
                                        decoder.innerHTML = html || '';
                                        const decoded = decoder.value || decoder.innerText || html || '';

                                        // Sanitize decoded HTML when in theme-adapted (dark) mode to remove forced light backgrounds/colors
                                        const sanitized = sanitizeHtmlForTheme(decoded, theme);

                                        // Basic injected CSS (gentle)  will be added to head of full-docs or wrapped otherwise
                                        const injectedStyles = `
                                            <style>
                                                :root{--app-link:${theme === 'dark' ? '#8ab4ff' : '#1a73e8'};--card-bg:${theme === 'dark' ? 'rgba(255,255,255,0.03)' : '#ffffff'};--card-border:${theme === 'dark' ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.08)'};--card-shadow:${theme === 'dark' ? 'none' : '0 6px 18px rgba(60,64,67,0.08)'}}
                                                /* Base layout tweaks */
                                                html,body{margin:0;padding:18px;background:transparent;color:inherit;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial}
                                                .gmail-wrapper{display:flex;justify-content:center;padding:12px 0}
                                                .gmail-card{width:100%;max-width:820px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:28px;box-shadow:var(--card-shadow);box-sizing:border-box}
                                                .gmail-inner{display:block;width:100%;box-sizing:border-box}
                                                img{max-width:100% !important;height:auto !important;display:block;margin:0 auto}
                                                table{max-width:100% !important;width:100% !important;border-collapse:collapse}
                                                a{color:var(--app-link) !important}
                                                .gmail-card > .gmail-card, .gmail-card .inner-card, .gmail-card .gmail-card, .gmail-card center > table, .gmail-card table[align="center"], .gmail-card table[width]{border:none !important;box-shadow:none !important;width:100% !important;max-width:100% !important;margin:0 !important;padding:0 !important}
                                                .gmail-card hr{border-color:rgba(0,0,0,0.08)}
                                                        /* Dark-mode stronger overrides to neutralize embedded light backgrounds */
                                                        ${theme === 'dark' ? `
                                                            /* Aggressive reset to override inline/background styles inside email HTML */
                                                            /* Force transparent backgrounds and readable text for all elements */
                                                            html, body { background: transparent !important; color: rgb(226,232,240) !important }
                                                            /* Star selector to neutralize deeply nested inline/backgrounds */
                                                            html, body, * { background: transparent !important; color: rgb(226,232,240) !important; border-color: rgba(255,255,255,0.06) !important }
                                                            /* Neutralize known table/card containers used by email clients */
                                                            table, td, th, div, center, section, main, table[width], table[height], table[role], .mdv2rw, .v2sp, .v2rsp { background: transparent !important }
                                                            /* Apply our card look to the iframe wrapper only */
                                                            .gmail-wrapper > .gmail-card, .gmail-card { background: var(--card-bg) !important; border-color: var(--card-border) !important }
                                                            .gmail-inner { background: rgba(255,255,255,0.02) !important; padding:12px; border-radius:6px }
                                                            /* Ensure links remain visible and other text inherits readable color */
                                                            a { color: #8ab4ff !important }
                                                            .gmail-card, .gmail-card * { color: rgb(226,232,240) !important }
                                                        ` : ''}
                                                @media (max-width:600px){.gmail-card{padding:16px;border-radius:10px}}
                                            </style>
                                        `;

                                        // If this looks like a full document, inject styles into its head
                                        const looksLikeDoc = /<!doctype|<html/i.test(sanitized);
                                        let srcdoc = '';

                                        if (looksLikeDoc) {
                                            // Parse the sanitized full document and extract safe head nodes and the body content.
                                            try {
                                                const parser2 = new DOMParser();
                                                const doc2 = parser2.parseFromString(sanitized, 'text/html');

                                                // Collect safe head nodes to preserve without style/script blocks.
                                                // IMPORTANT: skip external stylesheets to avoid email-provided CSS forcing a light theme
                                                let preservedHead = '';
                                                if (doc2.head) {
                                                    Array.from(doc2.head.children).forEach(node => {
                                                        const tag = node.tagName && node.tagName.toLowerCase();
                                                        if (tag === 'meta' || tag === 'base') {
                                                            preservedHead += node.outerHTML + '\n';
                                                        } else if (tag === 'link') {
                                                            try {
                                                                const rel = (node.getAttribute && (node.getAttribute('rel') || '')).toLowerCase();
                                                                // Allow only benign link rels; explicitly skip rel=stylesheet
                                                                const allowedRels = ['icon', 'shortcut icon', 'apple-touch-icon', 'preconnect', 'dns-prefetch', 'manifest'];
                                                                if (rel && allowedRels.includes(rel)) {
                                                                    preservedHead += node.outerHTML + '\n';
                                                                } else {
                                                                    // skip stylesheet or unknown link rel to prevent external CSS from loading
                                                                }
                                                            } catch (e) {
                                                                // On any unexpected node shape, skip preserving the link
                                                            }
                                                        }
                                                        // intentionally skip <style> and <script>
                                                    });
                                                }

                                                const bodyInner = (doc2.body && doc2.body.innerHTML) ? doc2.body.innerHTML : sanitized;

                                                // Build a wrapped doc so our gmail-card wrapper always applies
                                                srcdoc = '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">' + preservedHead + injectedStyles + '</head><body><div class="gmail-wrapper"><div class="gmail-card"><div class="gmail-inner">' + bodyInner + '</div></div></div></body></html>';
                                            } catch (e) {
                                                // Fallback to previous approach
                                                srcdoc = '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">' + injectedStyles + '</head><body><div class="gmail-wrapper"><div class="gmail-card"><div class="gmail-inner">' + sanitized + '</div></div></div></body></html>';
                                            }
                                        } else {
                                            srcdoc = '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">' + injectedStyles + '</head><body><div class="gmail-wrapper"><div class="gmail-card"><div class="gmail-inner">' + sanitized + '</div></div></div></body></html>';
                                        }

                                        const iframe = document.createElement('iframe');
                                        iframe.className = 'email-iframe border-0 rounded-2';
                                        iframe.setAttribute('sandbox', '');
                                        iframe.setAttribute('scrolling', 'auto');
                                        iframe.style.width = '100%';
                                        iframe.style.minHeight = '60vh';
                                        iframe.style.border = '0';
                                        iframe.srcdoc = srcdoc;

                                        container.appendChild(iframe);
                                } catch (err) {
                                        console.error('Failed to render HTML in iframe', err);
                                        container.innerText = html;
                                }
                        }

            async function copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    showSuccess(`Copied "${text}" to clipboard`);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showSuccess(`Copied "${text}" to clipboard`);
                    } catch (fallbackErr) {
                        showError('Failed to copy to clipboard');
                    }
                    document.body.removeChild(textArea);
                }
            }

            async function copyEmailContent() {
                if (!currentEmail) return;

                // Use received_at if available, otherwise fall back to created_at
                const emailDate = currentEmail.received_at ? new Date(currentEmail.received_at) : new Date(currentEmail.created_at);
                const emailContent = `
Subject: ${currentEmail.subject}
From: ${currentEmail.sender_email}
To: ${currentEmail.recipient_email}
${currentEmail.cc_emails ? `CC: ${currentEmail.cc_emails}` : ''}
Date: ${emailDate.toLocaleString()}

${currentEmail.body}
        `.trim();

                await copyToClipboard(emailContent);
            }

            function printEmail() {
                if (!currentEmail) return;

                // Use received_at if available, otherwise fall back to created_at
                const emailDate = currentEmail.received_at ? new Date(currentEmail.received_at) : new Date(currentEmail.created_at);
                const printContent = `
            <html>
                <head>
                    <title>Email - ${currentEmail.subject}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .subject { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; }
                        .meta { margin-bottom: 20px; background: #f5f5f5; padding: 15px; border-radius: 5px; }
                        .meta-item { margin-bottom: 5px; }
                        .label { font-weight: bold; }
                        .body { margin-top: 20px; white-space: pre-wrap; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="subject">${escapeHtml(currentEmail.subject)}</div>
                    </div>
                    <div class="meta">
                        <div class="meta-item"><span class="label">From:</span> ${escapeHtml(currentEmail.sender_email)}</div>
                        <div class="meta-item"><span class="label">To:</span> ${escapeHtml(currentEmail.recipient_email)}</div>
                        ${currentEmail.cc_emails ? `<div class="meta-item"><span class="label">CC:</span> ${escapeHtml(currentEmail.cc_emails)}</div>` : ''}
                        <div class="meta-item"><span class="label">Date:</span> ${emailDate.toLocaleString()}</div>
                        <div class="meta-item"><span class="label">Status:</span> ${currentEmail.is_important ? 'Important, ' : ''}${currentEmail.is_read ? 'Read' : 'Unread'}</div>
                    </div>
                    <div class="body">${escapeHtml(currentEmail.body)}</div>
                </body>
            </html>
        `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            }

            async function shareEmail() {
                if (!currentEmail) return;

                const emailContent = `Check out this email: "${currentEmail.subject}" from ${currentEmail.sender_email}`;

                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: currentEmail.subject,
                            text: emailContent,
                            url: window.location.href
                        });
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.error('Error sharing:', err);
                            fallbackShare(emailContent);
                        }
                    }
                } else {
                    fallbackShare(emailContent);
                }
            }

            function fallbackShare(content) {
                copyToClipboard(content);
                showSuccess('Email details copied to clipboard for sharing');
            }

            // Helper function to format file sizes
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';

                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));

                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            // Helper function to view images in fullscreen
            function viewImageFullscreen(imageSrc, filename) {
                Swal.fire({
                    title: filename,
                    imageUrl: imageSrc,
                    imageAlt: filename,
                    showCloseButton: true,
                    showConfirmButton: false,
                    width: 'auto',
                    maxWidth: '90vw',
                    background: getSweetAlertTheme().background,
                    color: getSweetAlertTheme().color,
                    customClass: {
                        image: 'img-fluid'
                    }
                });
            }
        </script>

<!-- SweetAlert2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<%- include('../components/footer.ejs') %>
